{% extends 'betting/base.html' %} {% load static %} {% block title %}Agent/Cashier Dashboard - Pool Betting{% endblock %} {% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">
            {% if user.user_type == 'agent' %} Agent Dashboard {% elif user.user_type == 'cashier' %} Cashier Dashboard {% else %} Dashboard {% endif %}
        </h2>
        {% if user.user_type == 'agent' %}
        <a href="{% url 'betting:wallet_transfer' %}" class="btn btn-success rounded-pill px-4 shadow-sm">
            <i class="fas fa-exchange-alt me-2"></i> Wallet Transfer
        </a>
        {% endif %}
    </div>

    {% if messages %} {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %} {% endif %}

    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm h-100 rounded-3">
                <div class="card-body">
                    <h5 class="card-title text-muted">My Wallet Balance</h5>
                    <p class="card-text fs-3 fw-bold text-success">₦{{ user.wallet.balance|floatformat:2 }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm h-100 rounded-3">
                <div class="card-body">
                    <h5 class="card-title text-muted">Total Downline Stake</h5>
                    <p class="card-text fs-3 fw-bold text-info">₦{{ total_downline_stake|floatformat:2 }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm h-100 rounded-3">
                <div class="card-body">
                    <h5 class="card-title text-muted">Total Downline Winnings</h5>
                    <p class="card-text fs-3 fw-bold text-warning">₦{{ total_downline_winnings|floatformat:2 }}</p>
                </div>
            </div>
        </div>
    </div>

    {% if user.user_type == 'agent' %}
    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm h-100 rounded-3">
                <div class="card-body">
                    <h5 class="card-title text-muted">Cashiers in Downline</h5>
                    <p class="card-text fs-3 fw-bold">{{ total_downline_cashiers }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm h-100 rounded-3">
                <div class="card-body">
                    <h5 class="card-title text-muted">Players in Downline</h5>
                    <p class="card-text fs-3 fw-bold">{{ total_downline_players }}</p>
                </div>
            </div>
        </div>
    </div>

    <h3 class="fw-bold text-secondary mb-3">Downline Users (Directly under you)</h3>
    {% if downline_users %}
    <div class="table-responsive bg-white rounded-3 shadow-sm p-3">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th scope="col">Email</th>
                    <th scope="col">Name</th>
                    <th scope="col">Type</th>
                    <th scope="col">Wallet Balance</th>
                </tr>
            </thead>
            <tbody>
                {% for d_user in downline_users %}
                <tr>
                    <td>{{ d_user.email }}</td>
                    <td>{{ d_user.get_full_name }}</td>
                    <td>{{ d_user.get_user_type_display }}</td>
                    <td>₦{{ d_user.wallet.balance|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="alert alert-info rounded-3 shadow-sm">No direct downline users found.</p>
    {% endif %}

    <h3 class="fw-bold text-secondary mt-5 mb-3">Downline Bet Tickets</h3>
    {% if downline_bet_tickets %}
    <div class="table-responsive bg-white rounded-3 shadow-sm p-3">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th scope="col">Ticket ID</th>
                    <th scope="col">User</th>
                    <th scope="col">Stake</th>
                    <th scope="col">Potential Winning</th>
                    <th scope="col">Status</th>
                    <th scope="col">Placed At</th>
                </tr>
            </thead>
            <tbody>
                {% for ticket in downline_bet_tickets %}
                <tr>
                    <td>{{ ticket.id|stringformat:"s"|slice:":8" }}...</td>
                    <td>{{ ticket.user.email }}</td>
                    <td>₦{{ ticket.stake_amount|floatformat:2 }}</td>
                    <td>₦{{ ticket.potential_winning|floatformat:2 }}</td>
                    <td><span class="badge bg-{{ ticket.status|lower }}">{{ ticket.status|capfirst }}</span></td>
                    <td>{{ ticket.placed_at|date:"Y-m-d H:i" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="alert alert-info rounded-3 shadow-sm">No downline bet tickets found.</p>
    {% endif %} {% if show_reports %}
    <h3 class="fw-bold text-secondary mt-5 mb-3">Reports</h3>
    <div class="row">
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm h-100 rounded-3">
                <div class="card-body text-center">
                    <h5 class="card-title">Wallet Transaction Report</h5>
                    <p class="card-text text-muted">View all wallet credit/debit transactions.</p>
                    <a href="{% url 'agent_wallet_report' %}" class="btn btn-outline-primary rounded-pill mt-3">View Report</a>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm h-100 rounded-3">
                <div class="card-body text-center">
                    <h5 class="card-title">Sales & Winnings Report</h5>
                    <p class="card-text text-muted">Analyze turnover, winnings, and losses.</p>
                    <a href="{% url 'agent_sales_winnings_report' %}" class="btn btn-outline-primary rounded-pill mt-3">View Report</a>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm h-100 rounded-3">
                <div class="card-body text-center">
                    <h5 class="card-title">Commission Report</h5>
                    <p class="card-text text-muted">Calculate your commission based on GGR.</p>
                    <a href="{% url 'agent_commission_report' %}" class="btn btn-outline-primary rounded-pill mt-3">View Report</a>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm h-100 rounded-3">
                <div class="card-body text-center">
                    <h5 class="card-title">Delete Bet Tickets</h5>
                    <p class="card-text text-muted">Initiate deletion of bet tickets for your downlines.</p>
                    <a href="{% url 'delete_bet_ticket' %}" class="btn btn-outline-danger rounded-pill mt-3">Delete Tickets</a>
                </div>
            </div>
        </div>
    </div>
    {% endif %} {% else %} {# For Cashier #}
    <h3 class="fw-bold text-secondary mt-5 mb-3">My Bet Tickets</h3>
    {% if downline_bet_tickets %} {# This will be just the cashier's own tickets now #}
    <div class="table-responsive bg-white rounded-3 shadow-sm p-3">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th scope="col">Ticket ID</th>
                    <th scope="col">Stake</th>
                    <th scope="col">Potential Winning</th>
                    <th scope="col">Status</th>
                    <th scope="col">Placed At</th>
                </tr>
            </thead>
            <tbody>
                {% for ticket in downline_bet_tickets %}
                <tr>
                    <td>{{ ticket.id|stringformat:"s"|slice:":8" }}...</td>
                    <td>₦{{ ticket.stake_amount|floatformat:2 }}</td>
                    <td>₦{{ ticket.potential_winning|floatformat:2 }}</td>
                    <td><span class="badge bg-{{ ticket.status|lower }}">{{ ticket.status|capfirst }}</span></td>
                    <td>{{ ticket.placed_at|date:"Y-m-d H:i" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="alert alert-info rounded-3 shadow-sm">No bet tickets found.</p>
    {% endif %} {% endif %}

</div>
{% endblock %}