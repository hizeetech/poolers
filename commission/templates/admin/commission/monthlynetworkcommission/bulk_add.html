{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block extrahead %}{{ block.super }}
<script type="text/javascript" src="{% url 'admin:jsi18n' %}"></script>
{{ media }}
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
&rsaquo; <a href="{% url 'admin:commission_monthlynetworkcommission_changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
&rsaquo; {% trans 'Bulk Commission Payment' %}
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <form action="" method="get">
        <fieldset class="module aligned">
            <div class="form-row">
                <label for="id_period" style="font-weight: bold; margin-right: 10px;">Select Commission Period:</label>
                <select name="period_id" id="id_period" onchange="this.form.submit()" style="padding: 5px;">
                    <option value="">-- Select Period --</option>
                    {% for p in periods %}
                        <option value="{{ p.id }}" {% if p.id|stringformat:"s" == selected_period_id %}selected{% endif %}>{{ p }}</option>
                    {% endfor %}
                </select>
            </div>
        </fieldset>
    </form>

    {% if selected_period_id %}
    <form action="" method="post">
        {% csrf_token %}
        <input type="hidden" name="period_id" value="{{ selected_period_id }}">
        
        {% if user_data %}
        <div class="results">
            <table id="result_list" style="width: 100%; border-collapse: collapse; margin-top: 20px;" class="table table-striped table-bordered">
                <thead>
                    <tr style="background: #f5f5f5; text-align: left;">
                        <th scope="col" class="action-checkbox-column" style="padding: 10px; border-bottom: 1px solid #ddd;">
                           <input type="checkbox" id="action-toggle" style="display: inline-block;">
                        </th>
                        <th scope="col" style="padding: 10px; border-bottom: 1px solid #ddd;">Network User</th>
                        <th scope="col" style="padding: 10px; border-bottom: 1px solid #ddd;">Role</th>
                        <th scope="col" style="padding: 10px; border-bottom: 1px solid #ddd;">Downline Stake</th>
                        <th scope="col" style="padding: 10px; border-bottom: 1px solid #ddd;">Downline Winnings</th>
                        <th scope="col" style="padding: 10px; border-bottom: 1px solid #ddd;">Downline Comm.</th>
                        <th scope="col" style="padding: 10px; border-bottom: 1px solid #ddd;">NGR</th>
                        <th scope="col" style="padding: 10px; border-bottom: 1px solid #ddd;">Comm %</th>
                        <th scope="col" style="padding: 10px; border-bottom: 1px solid #ddd;">Commission Amount</th>
                        <th scope="col" style="padding: 10px; border-bottom: 1px solid #ddd;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in user_data %}
                    <tr class="{% cycle 'row1' 'row2' %}">
                        <td class="action-checkbox" style="padding: 10px; border-bottom: 1px solid #ddd;">
                            {% if not row.is_paid %}
                            <input type="checkbox" name="selected_users" value="{{ row.user.id }}" class="action-select">
                            {% endif %}
                        </td>
                        <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ row.user }} ({{ row.user.email }})</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ row.data.role|title }}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ row.data.downline_stake }}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ row.data.downline_winnings }}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ row.data.downline_paid_commissions }}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ row.data.ngr }}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ddd;">{{ row.data.commission_percent }}%</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: bold;">{{ row.data.commission_amount }}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ddd;">
                            {% if row.is_paid %}
                                <img src="{% static 'admin/img/icon-yes.svg' %}" alt="Paid"> Paid
                            {% else %}
                                {{ row.status }}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="submit-row" style="margin-top: 20px;">
            <input type="submit" value="Pay Selected Commissions" class="default" name="_pay_selected" style="padding: 10px 20px; font-size: 14px; background: #417690; color: white; border: none; cursor: pointer;">
        </div>
        {% else %}
            <p style="margin-top: 20px;">No commissionable network users found for this period.</p>
        {% endif %}
    </form>
    
    <script>
        document.getElementById('action-toggle').addEventListener('change', function() {
            var checkboxes = document.querySelectorAll('.action-select');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = this.checked;
            }
        });
    </script>
    {% endif %}
</div>
{% endblock %}
