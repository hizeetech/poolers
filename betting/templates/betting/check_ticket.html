{% extends 'betting/base.html' %} {% load static %} {% load betting_extras %} {% block title %}Check Bet Ticket Status{% endblock %} 
{% block content %}
<style>
    .table-custom-compact th, .table-custom-compact td {
        font-size: 0.85rem;
        padding: 0.4rem 0.3rem;
        vertical-align: middle;
    }
    .table-custom-compact .btn-sm {
        padding: 0.15rem 0.4rem;
        font-size: 0.75rem;
    }
    .user-col-truncate {
        max-width: 120px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: inline-block;
        vertical-align: middle;
    }
</style>
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-sm rounded-lg">
                <div class="card-header bg-primary text-white text-center">
                    <h2 class="mb-0">Check Bet Ticket Status</h2>
                </div>
                <div class="card-body">
                    <p class="text-center text-muted mb-4">Enter your bet ticket ID to view its current status.</p>

                    <form method="post" action="{% url 'betting:check_ticket_status' %}" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="{{ form.ticket_id.id_for_label }}" class="form-label text-muted fw-medium">{{ form.ticket_id.label }}</label> {{ form.ticket_id }} {% if form.ticket_id.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.ticket_id.errors %} {{ error }} {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text text-muted">{{ form.ticket_id.help_text }}</div>
                        </div>

                        {% if form.non_field_errors %}
                        <div class="text-danger small mb-3">
                            {% for error in form.non_field_errors %} {{ error }} {% endfor %}
                        </div>
                        {% endif %}

                        <div class="d-grid gap-2 mb-3">
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill shadow-sm fw-bold">Check Status</button>
                        </div>
                        <p class="text-center text-muted mt-3">
                            <a href="{% url 'betting:fixtures' %}" class="text-decoration-none fw-semibold text-primary">Back to Fixtures</a>
                        </p>
                    </form>

                    {% if ticket %}
                    <hr class="my-4">
                    <h4 class="text-center mb-3">Ticket Details:</h4>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped mb-0">
                            <tbody>
                                <tr>
                                    <th>Ticket ID:</th>
                                    <td>{{ ticket.ticket_id }}</td>
                                </tr>
                                <tr>
                                    <th>Status:</th>
                                    <td>
                                        <span class="badge 
                                            {% if ticket.status == 'pending' %}bg-warning text-dark
                                            {% elif ticket.status == 'won' %}bg-success
                                            {% elif ticket.status == 'lost' %}bg-danger
                                            {% elif ticket.status == 'cashed_out' %}bg-info text-dark
                                            {% elif ticket.status == 'cancelled' %}bg-secondary
                                            {% elif ticket.status == 'deleted' %}bg-dark
                                            {% endif %}">
                                            {{ ticket.get_status_display }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Stake Amount:</th>
                                    <td>₦{{ ticket.stake_amount|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <th>Total Odd:</th>
                                    <td>{{ ticket.total_odd|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <th>Potential Winning:</th>
                                    <td>₦{{ ticket.potential_winning|floatformat:2 }}</td>
                                </tr>
                                {% if ticket.max_winning %}
                                <tr>
                                    <th>Max Winning (for multiple selections):</th>
                                    <td>₦{{ ticket.max_winning|floatformat:2 }}</td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <th>Placed By:</th>
                                    <td>{{ ticket.user.email }}</td>
                                </tr>
                                <tr>
                                    <th>Placed At:</th>
                                    <td>{{ ticket.placed_at|date:"Y-m-d H:i" }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h5 class="mt-4 mb-3">Selections:</h5>
                    {% if ticket.selections.all %}
                    <ul class="list-group list-group-flush">
                        {% for selection in ticket.selections.all %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <strong>{{ selection.fixture.home_team }} vs {{ selection.fixture.away_team }}</strong>
                            <span>
                                Pick: {{ selection.get_bet_type_display }} (Odd: {{ selection.odd_selected|floatformat:2 }})
                                {% if selection.is_winning_selection is True %}
                                    <span class="badge bg-success ms-2">WIN</span> 
                                {% elif selection.is_winning_selection is False %}
                                    <span class="badge bg-danger ms-2">LOSE</span> 
                                {% else %}
                                    {% if selection.fixture.status == 'cancelled' or selection.fixture.status == 'postponed' %}
                                        <span class="badge bg-secondary ms-2">VOID</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark ms-2">PENDING</span> 
                                    {% endif %}
                                {% endif %}
                            </span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-center text-muted">No selections found for this ticket.</p>
                    {% endif %} 
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Ticket History / Downline Tickets Section -->
    {% if request.user.is_authenticated %}
    <div class="container-fluid px-2 pb-5">
        <div class="row justify-content-center mt-5">
            <div class="col-12">
                <div class="card shadow-sm rounded-lg">
                    <div class="card-header bg-dark text-white py-2">
                        <h3 class="mb-0 h6">
                            {% if request.user.user_type == 'player' or request.user.user_type == 'cashier' %}
                                My Recent Tickets
                            {% else %}
                                Downline Tickets
                            {% endif %}
                        </h3>
                    </div>
                    
                    <!-- Filter Form -->
                    <div class="card-body border-bottom bg-light p-2">
                        <form method="get" class="row g-2 align-items-end">
                            <div class="col-md-2 col-6">
                                <label class="form-label small fw-bold text-muted mb-0">Ticket ID</label>
                                <input type="text" name="ticket_id" class="form-control form-control-sm" value="{{ request.GET.ticket_id|default:'' }}" placeholder="ID">
                            </div>
                            <div class="col-md-2 col-6">
                                <label class="form-label small fw-bold text-muted mb-0">Status</label>
                                <select name="status" class="form-select form-select-sm">
                                    <option value="all">All</option>
                                    {% for code, label in status_choices %}
                                    <option value="{{ code }}" {% if request.GET.status == code %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2 col-6">
                                <label class="form-label small fw-bold text-muted mb-0">Type</label>
                                <select name="bet_type" class="form-select form-select-sm">
                                    <option value="all">All</option>
                                    {% for code, label in bet_type_choices %}
                                    <option value="{{ code }}" {% if request.GET.bet_type == code %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2 col-6">
                                <label class="form-label small fw-bold text-muted mb-0">Stake Date</label>
                                <input type="date" name="date_from" class="form-control form-control-sm mb-1" value="{{ request.GET.date_from|default:'' }}" title="From">
                                <input type="date" name="date_to" class="form-control form-control-sm" value="{{ request.GET.date_to|default:'' }}" title="To">
                            </div>
                            <div class="col-md-2 col-6">
                                <label class="form-label small fw-bold text-muted mb-0">Settled Date</label>
                                <input type="date" name="settled_date_from" class="form-control form-control-sm mb-1" value="{{ request.GET.settled_date_from|default:'' }}" title="From">
                                <input type="date" name="settled_date_to" class="form-control form-control-sm" value="{{ request.GET.settled_date_to|default:'' }}" title="To">
                            </div>
                            <div class="col-md-2 col-12">
                                <div class="d-grid gap-1">
                                    <button type="submit" class="btn btn-primary btn-sm fw-bold">Filter</button>
                                    <a href="{% url 'betting:check_ticket_status' %}" class="btn btn-outline-secondary btn-sm">Clear</a>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped table-sm table-custom-compact mb-0">
                                <thead class="table-light">
                                    <tr class="text-nowrap">
                                        <th>Ticket ID</th>
                                        <th>Type</th>
                                        <th>Sel.</th>
                                        <th>Status</th>
                                        <th>Stake</th>
                                        <th>Pot. Win</th>
                                        <th>Min Win</th>
                                        <th>Max Win</th>
                                        <th>Won Amt</th>
                                        <th>Settled At</th>
                                        <th>User</th>
                                        <th>Date</th>
                                        <th class="text-end">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="ticket-list-body">
                                    {% include 'betting/partials/ticket_list_rows.html' %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Print Ticket Modal (Shared/Reused) -->
    <div class="modal fade" id="printTicketModal" tabindex="-1" aria-labelledby="printTicketModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="printTicketModalLabel">Ticket Copy</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4" id="ticket-content-to-print">
                    <div class="text-center mb-3">
                         <h4 class="fw-bold mb-0">PoolBetting</h4>
                         <small class="text-muted">Reprinted Copy</small>
                    </div>
                    
                    <div class="border-bottom pb-2 mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Ticket ID:</span>
                            <span class="fw-bold" id="modal-ticket-id"></span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Date:</span>
                            <span id="modal-placed-at"></span>
                        </div>
                    </div>

                    <h6 class="text-secondary mb-2">Selections:</h6>
                    <ul id="modal-selections-list" class="list-group list-group-flush mb-3 small">
                        <!-- Selections -->
                    </ul>

                    <div class="border-top pt-2">
                        <div class="d-flex justify-content-between">
                            <span>Stake:</span>
                            <span class="fw-bold" id="modal-stake-amount"></span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Total Odds:</span>
                            <span class="fw-bold" id="modal-total-odds"></span>
                        </div>
                        <div class="d-flex justify-content-between text-success">
                            <span>Max Win:</span>
                            <span class="fw-bold" id="modal-max-winning"></span>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <small class="text-muted d-block">Generated: <span id="modal-generation-time"></span></small>
                        <small class="text-muted d-block fst-italic">This is a duplicate copy.</small>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary btn-sm rounded-pill" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary btn-sm rounded-pill px-4" id="print-ticket-btn">
                        <i class="fas fa-print me-1"></i> Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
    .watermark {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 3rem;
        color: rgba(0, 0, 0, 0.1);
        z-index: 0;
        pointer-events: none;
        white-space: nowrap;
        font-weight: bold;
        border: 2px dashed rgba(0, 0, 0, 0.1);
        padding: 1rem;
    }
    #printTicketModal .modal-body {
        position: relative;
        overflow: hidden;
    }
    </style>
    <script>
    function rebetTicket(ticketId) {
        const btn = document.querySelector(`.rebet-btn-${ticketId}`);
        if(btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        }

        fetch(`{% url 'betting:get_ticket_details_json' %}?ticket_id=${ticketId}&mode=rebet`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    sessionStorage.setItem('rebet_data', JSON.stringify(data.ticket));
                    window.location.href = "{% url 'betting:fixtures' %}";
                } else {
                    alert('Error: ' + data.message);
                    if(btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-redo me-1"></i> Rebet';
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to load ticket details.');
                if(btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-redo me-1"></i> Rebet';
                }
            });
    }

    function reprintTicket(ticketId) {
        const btn = document.querySelector(`.reprint-btn-${ticketId}`);
        if(btn) btn.disabled = true;

        fetch(`{% url 'betting:get_ticket_details_json' %}?ticket_id=${ticketId}&mode=reprint`)
            .then(response => response.json())
            .then(data => {
                if(btn) btn.disabled = false;
                
                if (data.success) {
                    const ticket = data.ticket;
                    
                    // Populate fields
                    document.getElementById('modal-ticket-id').textContent = ticket.ticket_id;
                    document.getElementById('modal-placed-at').textContent = ticket.placed_at;
                    document.getElementById('modal-stake-amount').textContent = '₦' + ticket.stake_amount.toFixed(2);
                    document.getElementById('modal-total-odds').textContent = ticket.total_odd.toFixed(2);
                    document.getElementById('modal-max-winning').textContent = '₦' + ticket.max_winning.toFixed(2);
                    document.getElementById('modal-generation-time').textContent = new Date().toLocaleString();
                    
                    const list = document.getElementById('modal-selections-list');
                    list.innerHTML = '';
                    ticket.selections.forEach(sel => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item px-0 py-1 d-flex justify-content-between align-items-center';
                        li.innerHTML = `
                            <div>
                                <span class="d-block fw-bold text-dark">${sel.fixture_home_team} vs ${sel.fixture_away_team}</span>
                                <span class="text-muted small">${sel.bet_type_display}</span>
                            </div>
                            <span class="badge bg-light text-dark border">${sel.odd.toFixed(2)}</span>
                        `;
                        list.appendChild(li);
                    });

                    // Add Watermark
                    let watermark = document.getElementById('reprint-watermark');
                    if (!watermark) {
                        watermark = document.createElement('div');
                        watermark.id = 'reprint-watermark';
                        watermark.className = 'watermark';
                        watermark.textContent = 'COPY - NOT ORIGINAL';
                        document.querySelector('#printTicketModal .modal-body').appendChild(watermark);
                    } else {
                        watermark.style.display = 'block';
                    }

                    // Show Modal
                    const modal = new bootstrap.Modal(document.getElementById('printTicketModal'));
                    modal.show();

                    // Handle Print
                    document.getElementById('print-ticket-btn').onclick = function() {
                        logReprint(ticket.ticket_id);
                        
                        const printContent = document.getElementById('ticket-content-to-print').outerHTML;
                        const printWindow = window.open('', '', 'height=600,width=400');
                        printWindow.document.write('<html><head><title>Print Ticket</title>');
                        printWindow.document.write('<style>');
                        printWindow.document.write('body { font-family: "Courier New", monospace; width: 100%; max-width: 80mm; margin: 0; padding: 5px; color: #000; position: relative; }');
                        printWindow.document.write('.watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 2rem; color: rgba(0, 0, 0, 0.2); border: 2px dashed #000; padding: 1rem; z-index: 100; opacity: 0.5; pointer-events: none; }');
                        printWindow.document.write('.text-center { text-align: center; }');
                        printWindow.document.write('.fw-bold { font-weight: bold; }');
                        printWindow.document.write('.d-flex { display: flex; }');
                        printWindow.document.write('.justify-content-between { justify-content: space-between; }');
                        printWindow.document.write('.border-bottom { border-bottom: 1px dashed #000; }');
                        printWindow.document.write('.border-top { border-top: 1px dashed #000; }');
                        printWindow.document.write('.mb-3 { margin-bottom: 10px; }');
                        printWindow.document.write('.mb-2 { margin-bottom: 5px; }');
                        printWindow.document.write('.mt-4 { margin-top: 15px; }');
                        printWindow.document.write('.pt-2 { padding-top: 5px; }');
                        printWindow.document.write('.pb-2 { padding-bottom: 5px; }');
                        printWindow.document.write('.list-group-flush { list-style: none; padding: 0; margin: 0; }');
                        printWindow.document.write('.list-group-item { padding: 5px 0; border-bottom: 1px dotted #ccc; }');
                        printWindow.document.write('.badge { border: 1px solid #000; padding: 1px 3px; border-radius: 3px; font-size: 0.8em; }');
                        printWindow.document.write('.text-muted { color: #666; font-size: 0.85em; }');
                        printWindow.document.write('.small { font-size: 0.85em; }');
                        printWindow.document.write('h4, h5, h6 { margin: 5px 0; }');
                        printWindow.document.write('</style>');
                        printWindow.document.write('</head><body>');
                        printWindow.document.write(printContent);
                        printWindow.document.write('</body></html>');
                        printWindow.document.close();
                        
                        // Wait for content to load/render (though document.write is synchronous mostly)
                        setTimeout(function() {
                            printWindow.focus();
                            printWindow.print();
                            // printWindow.close(); // Optional: close after print
                        }, 500);
                    };

                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if(btn) btn.disabled = false;
            });
    }

    function logReprint(ticketId) {
        const formData = new FormData();
        formData.append('ticket_id', ticketId);
        
        fetch("{% url 'betting:log_ticket_reprint' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Poll for ticket updates every 5 seconds
        setInterval(function() {
            // Get current URL search params
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('action', 'poll_tickets');
            
            fetch("{% url 'betting:check_ticket_status' %}?" + urlParams.toString(), {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(html => {
                // Only update if we got valid HTML back (simple check)
                if (html.trim().length > 0) {
                    document.getElementById('ticket-list-body').innerHTML = html;
                }
            })
            .catch(error => console.error('Error polling tickets:', error));
        }, 5000);
    });
</script>
{% endblock %}
